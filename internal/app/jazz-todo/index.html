<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="./vnd/tailwind-2.2.16.min.css" rel="stylesheet" />
    <script src="./vnd/mithril-2.2.3.min.js"></script>
    <title>Jazz Todos</title>
  </head>
  <body class="h-full font-mono font-semibold bg-gray-300">
    <script type="module">
      import * as auth from "/auth/api.js";
      import * as jazz from "./jazz.js";

      if (!auth.isAuthenticated()) {
        localStorage.setItem("auth:redirect", "/");
        parent.location.href = "/auth/"; // login
      }

      const authSettings = JSON.parse(localStorage.getItem("auth:settings"));
      globalThis.node = await jazz.initNode(
        "jazz-todo", 
        authSettings["domain"],
        authSettings["clientId"],
        auth.accessToken(),
        (account) => {
            if (!account.get("root")) {
                account.set(
                    "root",
                    account.createMap({
                        todos: account.createList([]).id,
                    }).id
                );
            }
        },
      );
      console.log(node);

      const space = await jazz.setupSpace(node, (space) => {
        const todos = space.group.createList([]);
        space.mutate(s => {
          s.set("todos", todos.id);
        });
      });
      globalThis.space = space;

      let todos = await jazz.autoSubResolution(space.id, (s) => s?.todos, node);
      let username = await jazz.autoSubResolution("me", (me) => me.profile?.name, node);
      

      import {Store} from "./model.ts";
      import Todos from "./view.jsx";
      
      const store = new Store(node, todos, username);
      window.store = store;
      const inviteURL = jazz.createInviteLink(space, "admin");
      
      m.mount(document.body, {
        view: () => {
          return m(Todos, {store, inviteURL})
        }
      });

    </script>
  </body>
</html>
